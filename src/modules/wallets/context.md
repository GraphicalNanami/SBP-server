# Wallets Module Context

## Responsibilities
- Freighter wallet management (Stellar network)
- Wallet ownership verification via signature
- Primary wallet selection logic
- Maintaining 1:many relationship with the User entity
- Supporting wallet-based authentication flow (via AuthModule)

## Public Interfaces
- `WalletsService`: CRUD and logic for wallets
  - `findByUserId(userId)` → Wallet[] (Accepts UUID or ObjectId)
  - `findByAddress(address)` → Wallet | null (NEW: for wallet login lookup)
  - `addWallet(userId, address, nickname)` → { wallet, challenge }
  - `createVerifiedWallet(userId, address)` → Wallet (NEW: for wallet registration)
  - `verifyWallet(userId, walletId, signature, challenge)` → Wallet (Accepts UUID/ObjectId for walletId and userId)
  - `setPrimary(userId, walletId)` → Wallet
  - `removeWallet(userId, walletId)` → void
  - `findById(walletId)` → Wallet | null (Accepts UUID or ObjectId)
  - `findByUuid(uuid)` → Wallet | null
- `StellarVerificationService`: Low-level Stellar signature verification
  - `generateChallenge(walletId)` → string
  - `verifySignature(address, signature, challenge, walletId)` → boolean
- `WalletsController`: Endpoints for wallet management
  - `GET /wallets` — List user's wallets
  - `POST /wallets` — Add a new wallet (creates unverified)
  - `POST /wallets/:id/verify` — Verify wallet ownership
  - `POST /wallets/:id/set-primary` — Set as primary wallet
  - `PATCH /wallets/:id` — Update wallet nickname
  - `DELETE /wallets/:id` — Remove wallet

## Invariants
- Each user can have multiple wallets
- Only ONE wallet per user can be `isPrimary: true`
- `address` must be a valid Stellar public key (56 chars, starts with 'G')
- `address` must be unique across all wallets
- Verification challenges expire after 5 minutes
- Setting a wallet as primary automatically unsets any other primary wallet for that user
- Wallets created via `createVerifiedWallet` are automatically verified and set as primary
- Wallet challenges are one-time use and deleted after successful verification

## Dependencies
- `UsersModule`: To validate user existence
- `MongooseModule`: For MongoDB interaction
- `RedisModule`: For temporary storage of verification challenges
- `@stellar/stellar-sdk`: For signature verification and address validation
- Consumed by `AuthModule`: For wallet-based authentication flow

## Integration with Auth Flow
- AuthModule calls `findByAddress()` during wallet login to locate user
- AuthModule calls `createVerifiedWallet()` during wallet registration
- Wallet challenges generated by StellarVerificationService are verified during auth
- AuthModule updates `lastUsedAt` timestamp after successful wallet login
